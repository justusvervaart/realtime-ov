name: Monitor Waittimes Securityefilters Schiphol

on:
  workflow_dispatch:
  push:
  schedule:
    - cron: '0,15,30,45 * * * *'  # Voert elke 15 minuten uur uit

jobs:
  check-wait-times:
    runs-on: ubuntu-latest
    steps:
    - name: Install JQ
      run: sudo apt-get install jq

    - name: Check Wait Times
      run: |
        data=$(curl -s "https://www.schiphol.nl/api/proxy/v3/waittimes/security-filters")
        threshold_exceeded_locations=""
        
        for key in $(echo $data | jq -r 'keys[]'); do
          if [[ $key == VF* ]]; then
            wait_time=$(echo $data | jq -r --arg KEY $key '.[$KEY].waitTimeInSeconds')
            if (( wait_time > 60 )); then
              threshold_exceeded_locations="$threshold_exceeded_locations$key ($wait_time seconds), "
            fi
          fi
        done
        
        if [[ ! -z $threshold_exceeded_locations ]]; then
          echo "Alert! Locations exceeding the threshold: $threshold_exceeded_locations"
          exit 1
        else
          echo "All VF locations are within the acceptable wait time."
        fi

    - name: Send Email Notification
      if: failure()  # Dit zorgt ervoor dat deze stap alleen wordt uitgevoerd als een vorige stap is mislukt (bijv. de drempelwaarde werd overschreden)
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: Threshold Exceeded Alert from GitHub Actions
        body: Locations exceeding the threshold were detected in the API check.
        to: ${{ secrets.MAIL_TO }}
        from: ${{ secrets.MAIL_USERNAME }}

